<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIcam Janus Test Player</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; background: #10151f; color: #e6edf3; }
      input, button { font-size: 14px; padding: 8px; margin-right: 8px; }
      #live { width: min(100%, 960px); border: 1px solid #334155; border-radius: 8px; background: #000; }
      #log { white-space: pre-wrap; background: #0b1220; padding: 12px; border-radius: 8px; margin-top: 12px; max-width: 960px; }
    </style>
  </head>
  <body>
    <h1>Janus Streaming Test</h1>
    <div>
      <input id="server" value="http://localhost:8088/janus" size="40" />
      <input id="mountpoint" value="1" size="8" />
      <button id="start">Start</button>
      <button id="stop">Stop</button>
    </div>
    <video id="live" autoplay playsinline muted controls></video>
    <div id="log"></div>
    <script>
      const logEl = document.getElementById("log");
      const videoEl = document.getElementById("live");
      const state = { sessionId: null, handleId: null, pc: null, abort: null, keepalive: null };

      function log(msg) {
        const line = `[${new Date().toISOString()}] ${msg}`;
        logEl.textContent = `${line}\n${logEl.textContent}`.slice(0, 12000);
      }

      function tx() {
        return Math.random().toString(36).slice(2, 12);
      }

      async function janusPost(base, path, body, signal) {
        const response = await fetch(`${base}${path}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...body, transaction: tx() }),
          signal
        });
        if (!response.ok) {
          throw new Error(`Janus HTTP ${response.status}`);
        }
        return await response.json();
      }

      async function pollEvents(base, signal) {
        while (!signal.aborted && state.sessionId && state.handleId) {
          const rid = Date.now();
          const response = await fetch(`${base}/${state.sessionId}?rid=${rid}&maxev=1`, { signal });
          if (!response.ok) {
            throw new Error(`Janus poll ${response.status}`);
          }
          const msg = await response.json();
          if (msg.janus === "event" && msg.sender === state.handleId && msg.jsep) {
            await onJsepOffer(base, msg.jsep, signal);
          }
          if (msg.janus === "trickle" && msg.sender === state.handleId && msg.candidate && state.pc) {
            try {
              await state.pc.addIceCandidate(msg.candidate.completed ? null : msg.candidate);
            } catch (err) {
              log(`ICE candidate add failed: ${err}`);
            }
          }
        }
      }

      async function onJsepOffer(base, jsep, signal) {
        if (!state.pc) {
          state.pc = new RTCPeerConnection();
          state.pc.ontrack = (event) => {
            videoEl.srcObject = event.streams[0];
            log("Remote stream attached");
          };
          state.pc.onicecandidate = async (event) => {
            if (!state.sessionId || !state.handleId) return;
            await janusPost(base, `/${state.sessionId}/${state.handleId}`, {
              janus: "trickle",
              candidate: event.candidate || { completed: true }
            }, signal);
          };
        }
        await state.pc.setRemoteDescription(jsep);
        const answer = await state.pc.createAnswer();
        await state.pc.setLocalDescription(answer);
        await janusPost(base, `/${state.sessionId}/${state.handleId}`, {
          janus: "message",
          body: { request: "start" },
          jsep: state.pc.localDescription
        }, signal);
        log("Sent Janus start with SDP answer");
      }

      async function start() {
        const base = document.getElementById("server").value.trim().replace(/\/+$/, "");
        const mountpoint = Number(document.getElementById("mountpoint").value || "1");
        await stop();
        state.abort = new AbortController();
        const signal = state.abort.signal;
        log(`Starting Janus session on ${base}, mountpoint=${mountpoint}`);

        const create = await janusPost(base, "", { janus: "create" }, signal);
        state.sessionId = create.data.id;
        const attach = await janusPost(base, `/${state.sessionId}`, {
          janus: "attach",
          plugin: "janus.plugin.streaming"
        }, signal);
        state.handleId = attach.data.id;
        await janusPost(base, `/${state.sessionId}/${state.handleId}`, {
          janus: "message",
          body: { request: "watch", id: mountpoint }
        }, signal);
        state.keepalive = window.setInterval(() => {
          janusPost(base, `/${state.sessionId}`, { janus: "keepalive" }, signal).catch(() => {});
        }, 25000);
        pollEvents(base, signal).catch((err) => log(`Poll error: ${err}`));
      }

      async function stop() {
        if (state.keepalive) {
          window.clearInterval(state.keepalive);
          state.keepalive = null;
        }
        if (state.abort) {
          state.abort.abort();
          state.abort = null;
        }
        if (state.pc) {
          state.pc.close();
          state.pc = null;
        }
        if (videoEl.srcObject) {
          videoEl.srcObject = null;
        }
        state.handleId = null;
        state.sessionId = null;
      }

      document.getElementById("start").addEventListener("click", () => {
        start().catch((err) => log(`Start failed: ${err}`));
      });
      document.getElementById("stop").addEventListener("click", () => {
        stop().catch((err) => log(`Stop failed: ${err}`));
      });
    </script>
  </body>
</html>
